import { defaultComparator } from './local.sorter';
import { LocalFilter } from './local.filter';
import { LocalPager } from './local.pager';
import { DataSource } from '../data-source';
import { deepExtend } from '../../helpers';
export class LocalDataSource extends DataSource {
    constructor(data = []) {
        super();
        this.data = [];
        this.filteredAndSorted = [];
        this.sortConf = [];
        this.filterConf = {
            filters: [],
            andOperator: true,
        };
        this.pagingConf = { page: 1, perPage: 10 };
        this.selectedItems = [];
        this.data = data;
    }
    load(data) {
        this.data = data;
        return super.load(data);
    }
    prepend(element) {
        this.reset(true);
        this.data.unshift(element);
        return super.prepend(element);
    }
    append(element) {
        this.reset(true);
        this.data.push(element);
        return super.append(element);
    }
    add(element) {
        this.data.push(element);
        return super.add(element);
    }
    remove(element) {
        this.data = this.data.filter(el => el !== element);
        return super.remove(element);
    }
    update(element, values) {
        return new Promise((resolve, reject) => {
            this.find(element).then((found) => {
                found = deepExtend(found, values);
                super.update(found, values).then(resolve).catch(reject);
            }).catch(reject);
        });
    }
    find(element) {
        const found = this.data.find(el => el === element);
        if (found) {
            return Promise.resolve(found);
        }
        return Promise.reject(new Error('Element was not found in the dataset'));
    }
    getElements() {
        const data = this.data.slice(0);
        return Promise.resolve(this.prepareData(data));
    }
    getFilteredAndSorted() {
        let data = this.data.slice(0);
        this.prepareData(data); // this would return only the current page, but it sets filteredAndSorted array
        return Promise.resolve(this.filteredAndSorted);
    }
    getAll() {
        const data = this.data.slice(0);
        return Promise.resolve(data);
    }
    reset(silent = false) {
        if (silent) {
            this.filterConf = {
                filters: [],
                andOperator: true,
            };
            this.sortConf = [];
            this.pagingConf.page = 1;
        }
        else {
            this.setFilter([], true, false);
            this.setSort([], false);
            this.setPage(1);
        }
    }
    empty() {
        this.data = [];
        return super.empty();
    }
    count() {
        return this.filteredAndSorted.length;
    }
    toggleItem(row, isSelected) {
        if (isSelected)
            this.selectedItems.push(row);
        else
            this.selectedItems = this.selectedItems.filter((i) => i !== row);
    }
    // TODO: actually there is no need that this is an async function, but changing the signature would be a breaking change
    async selectAllItems(checked, onlyFiltered = false) {
        if (checked) {
            const itemsToSelect = onlyFiltered ? this.filteredAndSorted : this.data;
            this.selectedItems = itemsToSelect.slice(0);
        }
        else
            this.selectedItems = [];
    }
    isEveryElementSelected(onlyFiltered = false) {
        const itemsToCheck = onlyFiltered ? this.filteredAndSorted : this.data;
        if (onlyFiltered) {
            // TODO: this is an ugly and costly O(nÂ²) check, but currently we have no other choice....
            if (itemsToCheck.length !== this.selectedItems.length)
                return false;
            for (const item of itemsToCheck) {
                if (this.selectedItems.indexOf(itemsToCheck) < 0)
                    return false;
            }
            return true;
        }
        else {
            return itemsToCheck.length === this.selectedItems.length;
        }
    }
    getSelectedItems() {
        return this.selectedItems;
    }
    setSort(conf, doEmit = true) {
        this.sortConf = conf ?? [];
        super.setSort(conf, doEmit);
        return this;
    }
    updateSort(conf, doEmit = true) {
        if (conf !== null) {
            conf.forEach((fieldConf) => {
                const found = this.sortConf.findIndex(c => c.field === fieldConf.field);
                if (found >= 0) {
                    if (fieldConf.compare === undefined) {
                        // keep the previously configured compare function
                        fieldConf.compare = this.sortConf[found].compare;
                    }
                    this.sortConf.splice(found, 1);
                }
                // push the updated config to the front of the array (highest sort priority)
                this.sortConf = [fieldConf, ...this.sortConf];
            });
        }
        super.setSort(conf, doEmit);
        return this;
    }
    /**
     *
     * Array of conf objects
     * [
     *  {field: string, search: string, filter: Function|null},
     * ]
     * @param conf
     * @param andOperator
     * @param doEmit
     * @returns {LocalDataSource}
     */
    setFilter(conf, andOperator = true, doEmit = true) {
        if (conf && conf.length > 0) {
            conf.forEach((fieldConf) => {
                this.addFilter(fieldConf, andOperator, false);
            });
        }
        else {
            this.filterConf = {
                filters: [],
                andOperator: true,
            };
        }
        this.filterConf.andOperator = andOperator;
        this.pagingConf.page = 1;
        super.setFilter(conf, andOperator, doEmit);
        return this;
    }
    addFilter(fieldConf, andOperator = true, doEmit = true) {
        let found = false;
        this.filterConf.filters.forEach((currentFieldConf, index) => {
            if (currentFieldConf.field === fieldConf.field) {
                this.filterConf.filters[index] = fieldConf;
                found = true;
            }
        });
        if (!found) {
            this.filterConf.filters.push(fieldConf);
        }
        this.filterConf.andOperator = andOperator;
        super.addFilter(fieldConf, andOperator, doEmit);
        return this;
    }
    setPaging(page, perPage, doEmit = true) {
        this.pagingConf.page = page;
        this.pagingConf.perPage = perPage;
        super.setPaging(page, perPage, doEmit);
        return this;
    }
    setPage(page, doEmit = true) {
        this.pagingConf.page = page;
        super.setPage(page, doEmit);
        return this;
    }
    getSort() {
        return this.sortConf;
    }
    getFilter() {
        return this.filterConf;
    }
    getPaging() {
        return this.pagingConf;
    }
    prepareData(data) {
        data = this.filter(data);
        data = this.sort(data);
        this.filteredAndSorted = data.slice(0);
        return this.paginate(data);
    }
    sort(data) {
        // only use the part of the config where sorting is enabled
        const sortConfig = this.sortConf.filter(c => c.direction !== null);
        return data.sort((a, b) => {
            for (const sc of sortConfig) {
                const dir = (sc.direction === 'asc') ? 1 : -1;
                const compare = sc.compare ? sc.compare : defaultComparator;
                let parts = sc.field.split(".");
                let propA = a;
                for (let i = 0; i < parts.length && typeof propA !== 'undefined'; i++) {
                    propA = propA[parts[i]];
                }
                let propB = b;
                for (let i = 0; i < parts.length && typeof propB !== 'undefined'; i++) {
                    propB = propB[parts[i]];
                }
                const result = compare.call(null, dir, propA, propB);
                if (result !== 0)
                    return result;
            }
            return 0;
        });
    }
    // TODO: refactor?
    filter(data) {
        if (this.filterConf.filters) {
            if (this.filterConf.andOperator) {
                this.filterConf.filters.forEach(fieldConf => {
                    if (fieldConf.search.length > 0) {
                        data = LocalFilter.filter(data, fieldConf);
                    }
                });
            }
            else {
                let mergedData = [];
                this.filterConf.filters.forEach((fieldConf) => {
                    if (fieldConf['search'].length > 0) {
                        mergedData = mergedData.concat(LocalFilter.filter(data, fieldConf));
                    }
                });
                // remove non unique items
                data = mergedData.filter((elem, pos, arr) => {
                    return arr.indexOf(elem) === pos;
                });
            }
        }
        return data;
    }
    paginate(data) {
        return LocalPager.paginate(data, this.pagingConf.page, this.pagingConf.perPage);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYWwuZGF0YS1zb3VyY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9hbmd1bGFyMi1zbWFydC10YWJsZS9zcmMvbGliL2xpYi9kYXRhLXNvdXJjZS9sb2NhbC9sb2NhbC5kYXRhLXNvdXJjZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsaUJBQWlCLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUNqRCxPQUFPLEVBQUMsV0FBVyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLEVBQUMsVUFBVSxFQUErRCxNQUFNLGdCQUFnQixDQUFDO0FBQ3hHLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFFekMsTUFBTSxPQUFPLGVBQWdCLFNBQVEsVUFBVTtJQVk3QyxZQUFZLE9BQW1CLEVBQUU7UUFDL0IsS0FBSyxFQUFFLENBQUM7UUFYQSxTQUFJLEdBQWUsRUFBRSxDQUFDO1FBQ3RCLHNCQUFpQixHQUFlLEVBQUUsQ0FBQztRQUNuQyxhQUFRLEdBQXVCLEVBQUUsQ0FBQztRQUNsQyxlQUFVLEdBQXNCO1lBQ3hDLE9BQU8sRUFBRSxFQUFFO1lBQ1gsV0FBVyxFQUFFLElBQUk7U0FDbEIsQ0FBQztRQUNRLGVBQVUsR0FBa0IsRUFBQyxJQUFJLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUMsQ0FBQztRQUVyRCxrQkFBYSxHQUFlLEVBQUUsQ0FBQztRQUlyQyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztJQUNuQixDQUFDO0lBRUQsSUFBSSxDQUFDLElBQWdCO1FBQ25CLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBRWpCLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMxQixDQUFDO0lBRUQsT0FBTyxD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QUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtkZWZhdWx0Q29tcGFyYXRvcn0gZnJvbSAnLi9sb2NhbC5zb3J0ZXInO1xuaW1wb3J0IHtMb2NhbEZpbHRlcn0gZnJvbSAnLi9sb2NhbC5maWx0ZXInO1xuaW1wb3J0IHtMb2NhbFBhZ2VyfSBmcm9tICcuL2xvY2FsLnBhZ2VyJztcbmltcG9ydCB7RGF0YVNvdXJjZSwgSURhdGFTb3VyY2VGaWx0ZXIsIElGaWx0ZXJDb25maWcsIElQYWdpbmdDb25maWcsIElTb3J0Q29uZmlnfSBmcm9tICcuLi9kYXRhLXNvdXJjZSc7XG5pbXBvcnQge2RlZXBFeHRlbmR9IGZyb20gJy4uLy4uL2hlbHBlcnMnO1xuXG5leHBvcnQgY2xhc3MgTG9jYWxEYXRhU291cmNlIGV4dGVuZHMgRGF0YVNvdXJjZSB7XG5cbiAgcHJvdGVjdGVkIGRhdGE6IEFycmF5PGFueT4gPSBbXTtcbiAgcHJvdGVjdGVkIGZpbHRlcmVkQW5kU29ydGVkOiBBcnJheTxhbnk+ID0gW107XG4gIHByb3RlY3RlZCBzb3J0Q29uZjogQXJyYXk8SVNvcnRDb25maWc+ID0gW107XG4gIHByb3RlY3RlZCBmaWx0ZXJDb25mOiBJRGF0YVNvdXJjZUZpbHRlciA9IHtcbiAgICBmaWx0ZXJzOiBbXSxcbiAgICBhbmRPcGVyYXRvcjogdHJ1ZSxcbiAgfTtcbiAgcHJvdGVjdGVkIHBhZ2luZ0NvbmY6IElQYWdpbmdDb25maWcgPSB7cGFnZTogMSwgcGVyUGFnZTogMTB9O1xuXG4gIHByaXZhdGUgc2VsZWN0ZWRJdGVtczogQXJyYXk8YW55PiA9IFtdO1xuICBjb25zdHJ1Y3RvcihkYXRhOiBBcnJheTxhbnk+ID0gW10pIHtcbiAgICBzdXBlcigpO1xuXG4gICAgdGhpcy5kYXRhID0gZGF0YTtcbiAgfVxuXG4gIGxvYWQoZGF0YTogQXJyYXk8YW55Pik6IFByb21pc2U8YW55PiB7XG4gICAgdGhpcy5kYXRhID0gZGF0YTtcblxuICAgIHJldHVybiBzdXBlci5sb2FkKGRhdGEpO1xuICB9XG5cbiAgcHJlcGVuZChlbGVtZW50OiBhbnkpOiBQcm9taXNlPGFueT4ge1xuICAgIHRoaXMucmVzZXQodHJ1ZSk7XG5cbiAgICB0aGlzLmRhdGEudW5zaGlmdChlbGVtZW50KTtcbiAgICByZXR1cm4gc3VwZXIucHJlcGVuZChlbGVtZW50KTtcbiAgfVxuXG4gIGFwcGVuZChlbGVtZW50OiBhbnkpOiBQcm9taXNlPGFueT4ge1xuICAgIHRoaXMucmVzZXQodHJ1ZSk7XG5cbiAgICB0aGlzLmRhdGEucHVzaChlbGVtZW50KTtcbiAgICByZXR1cm4gc3VwZXIuYXBwZW5kKGVsZW1lbnQpO1xuICB9XG5cbiAgYWRkKGVsZW1lbnQ6IGFueSk6IFByb21pc2U8YW55PiB7XG4gICAgdGhpcy5kYXRhLnB1c2goZWxlbWVudCk7XG5cbiAgICByZXR1cm4gc3VwZXIuYWRkKGVsZW1lbnQpO1xuICB9XG5cbiAgcmVtb3ZlKGVsZW1lbnQ6IGFueSk6IFByb21pc2U8YW55PiB7XG4gICAgdGhpcy5kYXRhID0gdGhpcy5kYXRhLmZpbHRlcihlbCA9PiBlbCAhPT0gZWxlbWVudCk7XG5cbiAgICByZXR1cm4gc3VwZXIucmVtb3ZlKGVsZW1lbnQpO1xuICB9XG5cbiAgdXBkYXRlKGVsZW1lbnQ6IGFueSwgdmFsdWVzOiBhbnkpOiBQcm9taXNlPGFueT4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmZpbmQoZWxlbWVudCkudGhlbigoZm91bmQpID0+IHtcbiAgICAgICAgZm91bmQgPSBkZWVwRXh0ZW5kKGZvdW5kLCB2YWx1ZXMpO1xuICAgICAgICBzdXBlci51cGRhdGUoZm91bmQsIHZhbHVlcykudGhlbihyZXNvbHZlKS5jYXRjaChyZWplY3QpO1xuICAgICAgfSkuY2F0Y2gocmVqZWN0KTtcbiAgICB9KTtcbiAgfVxuXG4gIGZpbmQoZWxlbWVudDogYW55KTogUHJvbWlzZTxhbnk+IHtcbiAgICBjb25zdCBmb3VuZCA9IHRoaXMuZGF0YS5maW5kKGVsID0+IGVsID09PSBlbGVtZW50KTtcbiAgICBpZiAoZm91bmQpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZm91bmQpO1xuICAgIH1cblxuICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ0VsZW1lbnQgd2FzIG5vdCBmb3VuZCBpbiB0aGUgZGF0YXNldCcpKTtcbiAgfVxuXG4gIGdldEVsZW1lbnRzKCk6IFByb21pc2U8YW55PiB7XG4gICAgY29uc3QgZGF0YSA9IHRoaXMuZGF0YS5zbGljZSgwKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMucHJlcGFyZURhdGEoZGF0YSkpO1xuICB9XG5cbiAgZ2V0RmlsdGVyZWRBbmRTb3J0ZWQoKTogUHJvbWlzZTxhbnk+IHtcbiAgICBsZXQgZGF0YSA9IHRoaXMuZGF0YS5zbGljZSgwKTtcbiAgICB0aGlzLnByZXBhcmVEYXRhKGRhdGEpOyAvLyB0aGlzIHdvdWxkIHJldHVybiBvbmx5IHRoZSBjdXJyZW50IHBhZ2UsIGJ1dCBpdCBzZXRzIGZpbHRlcmVkQW5kU29ydGVkIGFycmF5XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0aGlzLmZpbHRlcmVkQW5kU29ydGVkKTtcbiAgfVxuXG4gIGdldEFsbCgpOiBQcm9taXNlPGFueT4ge1xuICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGEuc2xpY2UoMCk7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShkYXRhKTtcbiAgfVxuXG4gIHJlc2V0KHNpbGVudCA9IGZhbHNlKSB7XG4gICAgaWYgKHNpbGVudCkge1xuICAgICAgdGhpcy5maWx0ZXJDb25mID0ge1xuICAgICAgICBmaWx0ZXJzOiBbXSxcbiAgICAgICAgYW5kT3BlcmF0b3I6IHRydWUsXG4gICAgICB9O1xuICAgICAgdGhpcy5zb3J0Q29uZiA9IFtdO1xuICAgICAgdGhpcy5wYWdpbmdDb25mLnBhZ2UgPSAxO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNldEZpbHRlcihbXSwgdHJ1ZSwgZmFsc2UpO1xuICAgICAgdGhpcy5zZXRTb3J0KFtdLCBmYWxzZSk7XG4gICAgICB0aGlzLnNldFBhZ2UoMSk7XG4gICAgfVxuICB9XG5cbiAgZW1wdHkoKTogUHJvbWlzZTxhbnk+IHtcbiAgICB0aGlzLmRhdGEgPSBbXTtcblxuICAgIHJldHVybiBzdXBlci5lbXB0eSgpO1xuICB9XG5cbiAgY291bnQoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5maWx0ZXJlZEFuZFNvcnRlZC5sZW5ndGg7XG4gIH1cblxuICB0b2dnbGVJdGVtKHJvdzogYW55LCBpc1NlbGVjdGVkOiBib29sZWFuKTogdm9pZCB7XG4gICAgaWYgKGlzU2VsZWN0ZWQpIHRoaXMuc2VsZWN0ZWRJdGVtcy5wdXNoKHJvdyk7XG4gICAgZWxzZSB0aGlzLnNlbGVjdGVkSXRlbXMgPSB0aGlzLnNlbGVjdGVkSXRlbXMuZmlsdGVyKChpKSA9PiBpICE9PSByb3cpO1xuICB9XG5cbiAgLy8gVE9ETzogYWN0dWFsbHkgdGhlcmUgaXMgbm8gbmVlZCB0aGF0IHRoaXMgaXMgYW4gYXN5bmMgZnVuY3Rpb24sIGJ1dCBjaGFuZ2luZyB0aGUgc2lnbmF0dXJlIHdvdWxkIGJlIGEgYnJlYWtpbmcgY2hhbmdlXG4gIGFzeW5jIHNlbGVjdEFsbEl0ZW1zKGNoZWNrZWQ6IGJvb2xlYW4sIG9ubHlGaWx0ZXJlZDogYm9vbGVhbiA9IGZhbHNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKGNoZWNrZWQpIHtcbiAgICAgIGNvbnN0IGl0ZW1zVG9TZWxlY3QgPSBvbmx5RmlsdGVyZWQgPyB0aGlzLmZpbHRlcmVkQW5kU29ydGVkIDogdGhpcy5kYXRhO1xuICAgICAgdGhpcy5zZWxlY3RlZEl0ZW1zID0gaXRlbXNUb1NlbGVjdC5zbGljZSgwKTtcbiAgICB9IGVsc2UgdGhpcy5zZWxlY3RlZEl0ZW1zID0gW107XG4gIH1cblxuICBpc0V2ZXJ5RWxlbWVudFNlbGVjdGVkKG9ubHlGaWx0ZXJlZDogYm9vbGVhbiA9IGZhbHNlKTogYm9vbGVhbiB7XG4gICAgY29uc3QgaXRlbXNUb0NoZWNrID0gb25seUZpbHRlcmVkID8gdGhpcy5maWx0ZXJlZEFuZFNvcnRlZCA6IHRoaXMuZGF0YTtcbiAgICBpZiAob25seUZpbHRlcmVkKSB7XG4gICAgICAvLyBUT0RPOiB0aGlzIGlzIGFuIHVnbHkgYW5kIGNvc3RseSBPKG7CsikgY2hlY2ssIGJ1dCBjdXJyZW50bHkgd2UgaGF2ZSBubyBvdGhlciBjaG9pY2UuLi4uXG4gICAgICBpZiAoaXRlbXNUb0NoZWNrLmxlbmd0aCAhPT0gdGhpcy5zZWxlY3RlZEl0ZW1zLmxlbmd0aCkgcmV0dXJuIGZhbHNlO1xuICAgICAgZm9yIChjb25zdCBpdGVtIG9mIGl0ZW1zVG9DaGVjaykge1xuICAgICAgICBpZiAodGhpcy5zZWxlY3RlZEl0ZW1zLmluZGV4T2YoaXRlbXNUb0NoZWNrKSA8IDApIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gaXRlbXNUb0NoZWNrLmxlbmd0aCA9PT0gdGhpcy5zZWxlY3RlZEl0ZW1zLmxlbmd0aDtcbiAgICB9XG4gIH1cblxuICBnZXRTZWxlY3RlZEl0ZW1zKCk6IEFycmF5PGFueT4ge1xuICAgIHJldHVybiB0aGlzLnNlbGVjdGVkSXRlbXM7XG4gIH1cblxuICBzZXRTb3J0KGNvbmY6IEFycmF5PElTb3J0Q29uZmlnPiwgZG9FbWl0ID0gdHJ1ZSk6IExvY2FsRGF0YVNvdXJjZSB7XG4gICAgdGhpcy5zb3J0Q29uZiA9IGNvbmYgPz8gW107XG4gICAgc3VwZXIuc2V0U29ydChjb25mLCBkb0VtaXQpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgdXBkYXRlU29ydChjb25mOiBBcnJheTxJU29ydENvbmZpZz4sIGRvRW1pdCA9IHRydWUpOiBMb2NhbERhdGFTb3VyY2Uge1xuICAgIGlmIChjb25mICE9PSBudWxsKSB7XG4gICAgICBjb25mLmZvckVhY2goKGZpZWxkQ29uZikgPT4ge1xuICAgICAgICBjb25zdCBmb3VuZCA9IHRoaXMuc29ydENvbmYuZmluZEluZGV4KGMgPT4gYy5maWVsZCA9PT0gZmllbGRDb25mLmZpZWxkKTtcbiAgICAgICAgaWYgKGZvdW5kID49IDApIHtcbiAgICAgICAgICBpZiAoZmllbGRDb25mLmNvbXBhcmUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgLy8ga2VlcCB0aGUgcHJldmlvdXNseSBjb25maWd1cmVkIGNvbXBhcmUgZnVuY3Rpb25cbiAgICAgICAgICAgIGZpZWxkQ29uZi5jb21wYXJlID0gdGhpcy5zb3J0Q29uZltmb3VuZF0uY29tcGFyZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5zb3J0Q29uZi5zcGxpY2UoZm91bmQsIDEpO1xuICAgICAgICB9XG4gICAgICAgIC8vIHB1c2ggdGhlIHVwZGF0ZWQgY29uZmlnIHRvIHRoZSBmcm9udCBvZiB0aGUgYXJyYXkgKGhpZ2hlc3Qgc29ydCBwcmlvcml0eSlcbiAgICAgICAgdGhpcy5zb3J0Q29uZiA9IFtmaWVsZENvbmYsIC4uLnRoaXMuc29ydENvbmZdO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHN1cGVyLnNldFNvcnQoY29uZiwgZG9FbWl0KTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBBcnJheSBvZiBjb25mIG9iamVjdHNcbiAgICogW1xuICAgKiAge2ZpZWxkOiBzdHJpbmcsIHNlYXJjaDogc3RyaW5nLCBmaWx0ZXI6IEZ1bmN0aW9ufG51bGx9LFxuICAgKiBdXG4gICAqIEBwYXJhbSBjb25mXG4gICAqIEBwYXJhbSBhbmRPcGVyYXRvclxuICAgKiBAcGFyYW0gZG9FbWl0XG4gICAqIEByZXR1cm5zIHtMb2NhbERhdGFTb3VyY2V9XG4gICAqL1xuICBzZXRGaWx0ZXIoY29uZjogQXJyYXk8SUZpbHRlckNvbmZpZz4sIGFuZE9wZXJhdG9yID0gdHJ1ZSwgZG9FbWl0ID0gdHJ1ZSk6IExvY2FsRGF0YVNvdXJjZSB7XG4gICAgaWYgKGNvbmYgJiYgY29uZi5sZW5ndGggPiAwKSB7XG4gICAgICBjb25mLmZvckVhY2goKGZpZWxkQ29uZikgPT4ge1xuICAgICAgICB0aGlzLmFkZEZpbHRlcihmaWVsZENvbmYsIGFuZE9wZXJhdG9yLCBmYWxzZSk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5maWx0ZXJDb25mID0ge1xuICAgICAgICBmaWx0ZXJzOiBbXSxcbiAgICAgICAgYW5kT3BlcmF0b3I6IHRydWUsXG4gICAgICB9O1xuICAgIH1cbiAgICB0aGlzLmZpbHRlckNvbmYuYW5kT3BlcmF0b3IgPSBhbmRPcGVyYXRvcjtcbiAgICB0aGlzLnBhZ2luZ0NvbmYucGFnZSA9IDE7XG5cbiAgICBzdXBlci5zZXRGaWx0ZXIoY29uZiwgYW5kT3BlcmF0b3IsIGRvRW1pdCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBhZGRGaWx0ZXIoZmllbGRDb25mOiBJRmlsdGVyQ29uZmlnLCBhbmRPcGVyYXRvciA9IHRydWUsIGRvRW1pdDogYm9vbGVhbiA9IHRydWUpOiBMb2NhbERhdGFTb3VyY2Uge1xuICAgIGxldCBmb3VuZCA9IGZhbHNlO1xuICAgIHRoaXMuZmlsdGVyQ29uZi5maWx0ZXJzLmZvckVhY2goKGN1cnJlbnRGaWVsZENvbmY6IElGaWx0ZXJDb25maWcsIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgIGlmIChjdXJyZW50RmllbGRDb25mLmZpZWxkID09PSBmaWVsZENvbmYuZmllbGQpIHtcbiAgICAgICAgdGhpcy5maWx0ZXJDb25mLmZpbHRlcnNbaW5kZXhdID0gZmllbGRDb25mO1xuICAgICAgICBmb3VuZCA9IHRydWU7XG4gICAgICB9XG4gICAgfSk7XG4gICAgaWYgKCFmb3VuZCkge1xuICAgICAgdGhpcy5maWx0ZXJDb25mLmZpbHRlcnMucHVzaChmaWVsZENvbmYpO1xuICAgIH1cbiAgICB0aGlzLmZpbHRlckNvbmYuYW5kT3BlcmF0b3IgPSBhbmRPcGVyYXRvcjtcbiAgICBzdXBlci5hZGRGaWx0ZXIoZmllbGRDb25mLCBhbmRPcGVyYXRvciwgZG9FbWl0KTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHNldFBhZ2luZyhwYWdlOiBudW1iZXIsIHBlclBhZ2U6IG51bWJlciwgZG9FbWl0OiBib29sZWFuID0gdHJ1ZSk6IExvY2FsRGF0YVNvdXJjZSB7XG4gICAgdGhpcy5wYWdpbmdDb25mLnBhZ2UgPSBwYWdlO1xuICAgIHRoaXMucGFnaW5nQ29uZi5wZXJQYWdlID0gcGVyUGFnZTtcblxuICAgIHN1cGVyLnNldFBhZ2luZyhwYWdlLCBwZXJQYWdlLCBkb0VtaXQpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgc2V0UGFnZShwYWdlOiBudW1iZXIsIGRvRW1pdDogYm9vbGVhbiA9IHRydWUpOiBMb2NhbERhdGFTb3VyY2Uge1xuICAgIHRoaXMucGFnaW5nQ29uZi5wYWdlID0gcGFnZTtcbiAgICBzdXBlci5zZXRQYWdlKHBhZ2UsIGRvRW1pdCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBnZXRTb3J0KCk6IEFycmF5PElTb3J0Q29uZmlnPiB7XG4gICAgcmV0dXJuIHRoaXMuc29ydENvbmY7XG4gIH1cblxuICBnZXRGaWx0ZXIoKTogSURhdGFTb3VyY2VGaWx0ZXIge1xuICAgIHJldHVybiB0aGlzLmZpbHRlckNvbmY7XG4gIH1cblxuICBnZXRQYWdpbmcoKTogSVBhZ2luZ0NvbmZpZyB7XG4gICAgcmV0dXJuIHRoaXMucGFnaW5nQ29uZjtcbiAgfVxuXG4gIHByb3RlY3RlZCBwcmVwYXJlRGF0YShkYXRhOiBBcnJheTxhbnk+KTogQXJyYXk8YW55PiB7XG4gICAgZGF0YSA9IHRoaXMuZmlsdGVyKGRhdGEpO1xuICAgIGRhdGEgPSB0aGlzLnNvcnQoZGF0YSk7XG4gICAgdGhpcy5maWx0ZXJlZEFuZFNvcnRlZCA9IGRhdGEuc2xpY2UoMCk7XG5cbiAgICByZXR1cm4gdGhpcy5wYWdpbmF0ZShkYXRhKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBzb3J0KGRhdGE6IEFycmF5PGFueT4pOiBBcnJheTxhbnk+IHtcbiAgICAvLyBvbmx5IHVzZSB0aGUgcGFydCBvZiB0aGUgY29uZmlnIHdoZXJlIHNvcnRpbmcgaXMgZW5hYmxlZFxuICAgIGNvbnN0IHNvcnRDb25maWcgPSB0aGlzLnNvcnRDb25mLmZpbHRlcihjID0+IGMuZGlyZWN0aW9uICE9PSBudWxsKTtcblxuICAgIHJldHVybiBkYXRhLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgIGZvciAoY29uc3Qgc2Mgb2Ygc29ydENvbmZpZykge1xuICAgICAgICBjb25zdCBkaXI6IG51bWJlciA9IChzYy5kaXJlY3Rpb24gPT09ICdhc2MnKSA/IDEgOiAtMTtcbiAgICAgICAgY29uc3QgY29tcGFyZTogRnVuY3Rpb24gPSBzYy5jb21wYXJlID8gc2MuY29tcGFyZSA6IGRlZmF1bHRDb21wYXJhdG9yO1xuICAgICAgICBsZXQgcGFydHMgPSBzYy5maWVsZC5zcGxpdChcIi5cIik7XG4gICAgICAgIGxldCBwcm9wQSA9IGE7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoICYmIHR5cGVvZiBwcm9wQSAhPT0gJ3VuZGVmaW5lZCc7IGkrKykge1xuICAgICAgICAgIHByb3BBID0gcHJvcEFbcGFydHNbaV1dO1xuICAgICAgICB9XG4gICAgICAgIGxldCBwcm9wQiA9IGI7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoICYmIHR5cGVvZiBwcm9wQiAhPT0gJ3VuZGVmaW5lZCc7IGkrKykge1xuICAgICAgICAgIHByb3BCID0gcHJvcEJbcGFydHNbaV1dO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGNvbXBhcmUuY2FsbChudWxsLCBkaXIsIHByb3BBLCBwcm9wQik7XG4gICAgICAgIGlmIChyZXN1bHQgIT09IDApIHJldHVybiByZXN1bHQ7XG4gICAgICB9XG4gICAgICByZXR1cm4gMDtcbiAgICB9KTtcbiAgfVxuXG4gIC8vIFRPRE86IHJlZmFjdG9yP1xuICBwcm90ZWN0ZWQgZmlsdGVyKGRhdGE6IEFycmF5PGFueT4pOiBBcnJheTxhbnk+IHtcbiAgICBpZiAodGhpcy5maWx0ZXJDb25mLmZpbHRlcnMpIHtcbiAgICAgIGlmICh0aGlzLmZpbHRlckNvbmYuYW5kT3BlcmF0b3IpIHtcbiAgICAgICAgdGhpcy5maWx0ZXJDb25mLmZpbHRlcnMuZm9yRWFjaChmaWVsZENvbmYgPT4ge1xuICAgICAgICAgIGlmIChmaWVsZENvbmYuc2VhcmNoLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGRhdGEgPSBMb2NhbEZpbHRlci5maWx0ZXIoZGF0YSwgZmllbGRDb25mKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGV0IG1lcmdlZERhdGE6IGFueSA9IFtdO1xuICAgICAgICB0aGlzLmZpbHRlckNvbmYuZmlsdGVycy5mb3JFYWNoKChmaWVsZENvbmY6IGFueSkgPT4ge1xuICAgICAgICAgIGlmIChmaWVsZENvbmZbJ3NlYXJjaCddLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIG1lcmdlZERhdGEgPSBtZXJnZWREYXRhLmNvbmNhdChMb2NhbEZpbHRlci5maWx0ZXIoZGF0YSwgZmllbGRDb25mKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgLy8gcmVtb3ZlIG5vbiB1bmlxdWUgaXRlbXNcbiAgICAgICAgZGF0YSA9IG1lcmdlZERhdGEuZmlsdGVyKChlbGVtOiBhbnksIHBvczogYW55LCBhcnI6IGFueSkgPT4ge1xuICAgICAgICAgIHJldHVybiBhcnIuaW5kZXhPZihlbGVtKSA9PT0gcG9zO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cblxuICBwcm90ZWN0ZWQgcGFnaW5hdGUoZGF0YTogQXJyYXk8YW55Pik6IEFycmF5PGFueT4ge1xuICAgIHJldHVybiBMb2NhbFBhZ2VyLnBhZ2luYXRlKGRhdGEsIHRoaXMucGFnaW5nQ29uZi5wYWdlLCB0aGlzLnBhZ2luZ0NvbmYucGVyUGFnZSk7XG4gIH1cbn1cbiJdfQ==